<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Timer Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #3b6546;
            --card-bg: #1f1f1f;
            --input-bg: #2d2d2d;
            --text-color: #ffffff;
            --accent-color: #1db954;
            --danger-color: #e74c3c;
            --secondary-text: #a0a0a0;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.5s;
        }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© --- */
        .header-controls {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .focus-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
        }
        .focus-btn:hover { background: rgba(255,255,255,0.25); }

        /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² */
        .exit-focus-btn {
            display: none;
            background: var(--danger-color);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            font-family: 'Cairo', sans-serif;
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 9999;
        }
        .exit-focus-btn:hover {
            background: #c0392b;
        }

        /* --- Ø§Ù„Ø³Ø§Ø¹Ø© --- */
        .clock-container {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        .big-clock {
            font-size: 5rem;
            font-weight: 700;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: 2px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .date-badge {
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --- */
        .nav-pill {
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 12px;
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
        }
        .nav-pill button {
            background: transparent;
            border: none;
            color: #ccc;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: 0.3s;
        }
        .nav-pill button:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-pill button.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(29, 185, 84, 0.3);
        }

        /* --- Ø§Ù„ØªØ®Ø·ÙŠØ· --- */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 450px;
            gap: 20px;
            width: 100%;
            max-width: 800px;
            justify-content: center;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* --- ÙƒØ§Ø±Øª Ø§Ù„Ø£ØµÙˆØ§Øª --- */
        .sound-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sound-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sound-label { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        
        /* Ø²Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª */
        .play-btn {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .play-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .play-btn.playing {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* --- ÙƒØ§Ø±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
        .main-card { text-align: center; }
        .grid-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        .input-box {
            background: var(--input-bg);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .input-box label {
            font-size: 0.85rem;
            color: #aaa;
        }
        .input-box input[type="number"] {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
            font-family: 'Segoe UI', sans-serif;
        }
        .input-box input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn-action {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-family: 'Cairo', sans-serif;
            transition: 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn-action.start { background: var(--accent-color); color: white; }
        .btn-action.pause { background: #f1c40f; color: #1e1e1e; }
        
        .timer-running {
            font-size: 6rem;
            color: var(--accent-color);
            font-family: 'Segoe UI', sans-serif;
            margin: 20px 0;
            font-weight: bold;
        }

        /* --- ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² --- */
        body.focus-active {
            justify-content: center;
            padding: 0;
        }
        body.focus-active .main-layout, 
        body.focus-active .nav-pill,
        body.focus-active .header-controls,
        body.focus-active .date-badge {
            display: none !important;
        }
        
        body.focus-active .exit-focus-btn {
            display: block;
        }

        body.focus-active .clock-container {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }
        body.focus-active .big-clock {
            font-size: 8rem;
            opacity: 0.9;
        }

        /* Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ/Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² */
        .focus-timer-display {
            display: none !important; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            position: fixed;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px 40px;
        }
        
        body.focus-active .focus-timer-display.active {
            display: block !important; /* ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù…Ø§ ÙŠÙƒÙˆÙ† active */
        }
        
        .focus-timer-display .timer-text {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent-color);
            font-family: 'Segoe UI', sans-serif;
            margin-bottom: 5px;
        }
        
        .focus-timer-display .timer-label {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .focus-timer-display .timer-cycle {
            font-size: 1rem;
            color: #666;
        }
        
        .focus-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .focus-control-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        
        .focus-control-btn:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .focus-control-btn.pause-btn {
            background: rgba(241, 196, 15, 0.2);
            border-color: rgba(241, 196, 15, 0.4);
        }
        
        .focus-control-btn.stop-btn {
            background: rgba(231, 76, 60, 0.2);
            border-color: rgba(231, 76, 60, 0.4);
        }

        /* Ø§Ù„Ø£Ø°ÙƒØ§Ø± */
        .athkar-container {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            text-align: center;
            color: #f1c40f;
            opacity: 0;
            transition: opacity 1s;
            pointer-events: none;
            width: 90%;
            max-width: 600px;
        }
        body.focus-active .athkar-container { opacity: 1; }

        .hidden { display: none !important; }

        /* ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… */
        #task-input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #2d2d2d;
            color: white;
            font-family: 'Cairo', sans-serif;
        }
        
        .task-add-btn {
            background: var(--accent-color);
            border: none;
            border-radius: 8px;
            width: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            color: white;
            transition: 0.3s;
        }
        .task-add-btn:hover {
            background: #17a042;
        }

        .task-item {
            background: rgba(255,255,255,0.1);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }
        .task-item:hover {
            background: rgba(255,255,255,0.15);
        }
        .task-text {
            cursor: pointer;
            flex: 1;
            text-align: right;
        }
        .task-text.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }
        .task-delete-btn {
            background: var(--danger-color);
            border: none;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }
        .task-delete-btn:hover {
            background: #c0392b;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            .big-clock { font-size: 3.5rem; }
            body.focus-active .big-clock { font-size: 4.5rem; }
            .athkar-container { font-size: 1.4rem; }
            .timer-running { font-size: 4rem; }
            .header-controls {
                padding: 0 10px;
            }
            
            /* Ø¥ØµÙ„Ø§Ø­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            body.focus-active .clock-container {
                top: 30%;
            }
            
            .focus-timer-display {
                top: 55%;
                padding: 15px 25px;
            }
            
            .focus-timer-display .timer-text {
                font-size: 3rem;
            }
            
            .focus-timer-display .timer-label {
                font-size: 1rem;
            }
            
            .focus-timer-display .timer-cycle {
                font-size: 0.9rem;
            }
            
            .focus-control-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            body.focus-active .athkar-container {
                bottom: 30px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

    <button class="exit-focus-btn" onclick="toggleFocusMode()">âœ• Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²</button>

    <div class="header-controls">
        <button class="focus-btn" onclick="toggleFocusMode()">âœ¨ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
    </div>

    <div class="clock-container">
        <div class="big-clock" id="clock">00:00:00</div>
        <div class="date-badge" id="date">--</div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ/Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² -->
    <div class="focus-timer-display" id="focus-timer-display">
        <div class="timer-label" id="focus-timer-label">ğŸ¯ ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²</div>
        <div class="timer-text" id="focus-timer-text">25:00</div>
        <div class="timer-cycle" id="focus-timer-cycle"></div>
        <div class="focus-controls">
            <button class="focus-control-btn pause-btn" id="focus-pause-btn" onclick="togglePausePomo()">â¸ Ø¥ÙŠÙ‚Ø§Ù</button>
            <button class="focus-control-btn stop-btn" onclick="stopFocusTimer()">â¹ Ø¥Ù†Ù‡Ø§Ø¡</button>
        </div>
    </div>

    <div class="nav-pill">
        <button class="active" onclick="switchTab('pomo')" id="btn-pomo">â° Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</button>
        <button onclick="switchTab('timer')" id="btn-timer">â³ Ù…Ø¤Ù‚Øª</button>
        <button onclick="switchTab('tasks')" id="btn-tasks">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    </div>

    <div class="main-layout" id="main-content">
        
        <div class="sidebar">
            <div class="card">
                <div style="color:#aaa; margin-bottom:15px; font-weight:bold;">ğŸ”Š Ø£ØµÙˆØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©</div>
                
                <div class="sound-item">
                    <div class="sound-header-row">
                        <div class="sound-label">ğŸŒ§ï¸ ØµÙˆØª Ø§Ù„Ù…Ø·Ø±</div>
                        <button class="play-btn" id="btn-rain" onclick="toggleSound('rain')">â–¶</button>
                    </div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setVolume('rain', this.value)">
                </div>

                <div class="sound-item">
                    <div class="sound-header-row">
                        <div class="sound-label">âš¡ ØµÙˆØª Ø§Ù„Ø±Ø¹Ø¯</div>
                        <button class="play-btn" id="btn-thunder" onclick="toggleSound('thunder')">â–¶</button>
                    </div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setVolume('thunder', this.value)">
                </div>

                <div class="sound-item">
                    <div class="sound-header-row">
                        <div class="sound-label">ğŸ’¨ ØµÙˆØª Ø§Ù„Ø±ÙŠØ§Ø­</div>
                        <button class="play-btn" id="btn-wind" onclick="toggleSound('wind')">â–¶</button>
                    </div>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setVolume('wind', this.value)">
                </div>
            </div>

            <div class="card" style="margin-top:15px; font-size:0.9rem; color:#ccc; line-height:1.6;">
                ğŸ”” <b>ØªÙ„Ù…ÙŠØ­:</b> Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø³ØªØ®ØªÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©.
            </div>
        </div>

        <div class="card main-card">
            
            <div id="pomo-view">
                <div id="pomo-setup">
                    <h2>ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
                    <div class="grid-inputs">
                        <div class="input-box">
                            <label>Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                            <input type="number" id="p_focus" value="25" min="1" max="120">
                        </div>
                        <div class="input-box">
                            <label>Ø§Ù„Ø±Ø§Ø­Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                            <input type="number" id="p_short" value="5" min="1" max="60">
                        </div>
                        <div class="input-box" style="justify-content:center; cursor:pointer;" onclick="toggleCheckbox()">
                            <label>Ø§Ù†ØªÙ‚Ø§Ù„ Ø¢Ù„ÙŠ</label>
                            <input type="checkbox" id="p_auto" checked>
                        </div>
                        <div class="input-box">
                            <label>Ø§Ù„Ø¯ÙˆØ±Ø§Øª</label>
                            <input type="number" id="p_cycles" value="4" min="1" max="20">
                        </div>
                    </div>
                    <button class="btn-action start" onclick="startPomo()">
                        <span>â–¶</span> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø©
                    </button>
                </div>

                <div id="pomo-running" class="hidden">
                    <div id="p_status_text" style="color:#aaa; font-size:1.2rem;">ğŸ¯ ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²</div>
                    <div class="timer-running" id="p_timer_display">25:00</div>
                    <div style="margin-bottom:20px; color:#888;">Ø¯ÙˆØ±Ø©: <span id="cycle_display">1/4</span></div>
                    
                    <div style="display:flex; gap:10px;">
                        <button class="btn-action pause" onclick="togglePausePomo()" id="p_pause_btn">â¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                        <button class="btn-action" style="background:var(--danger-color); color:white;" onclick="resetPomo()">â¹ Ø¥Ù†Ù‡Ø§Ø¡</button>
                    </div>
                </div>
            </div>

            <div id="timer-view" class="hidden">
                <h2>Ù…Ø¤Ù‚Øª ØªÙ†Ø§Ø²Ù„ÙŠ</h2>
                <div class="grid-inputs" id="timer-setup">
                    <div class="input-box"><label>Ø¯Ù‚Ø§Ø¦Ù‚</label><input type="number" id="t_min" value="10" min="0" max="999"></div>
                    <div class="input-box"><label>Ø«ÙˆØ§Ù†ÙŠ</label><input type="number" id="t_sec" value="0" min="0" max="59"></div>
                </div>
                <div id="timer-running-display" class="hidden">
                    <div class="timer-running" id="t_display">00:00</div>
                </div>
                <button class="btn-action start" onclick="handleTimerBtn()" id="t_action_btn">â–¶ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª</button>
            </div>

            <div id="tasks-view" class="hidden">
                <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="task-input" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
                    <button onclick="addTask()" class="task-add-btn">+</button>
                </div>
                <ul id="task-list" style="list-style:none; padding:0; text-align:right;"></ul>
            </div>
        </div>
    </div>

    <div id="athkar-box" class="athkar-container">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡</div>



    <script>
        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙˆØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API ---
        let audioContext;
        let rainNoiseNode, thunderNoiseNode, windNoiseNode;
        let rainGain, thunderGain, windGain;
        let activeNatureSounds = { rain: false, thunder: false, wind: false };

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }

        // --- ØªÙˆÙ„ÙŠØ¯ Ø£ØµÙˆØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ---
        function createRainSound() {
            const ctx = initAudioContext();
            
            // White noise Ù„Ù„Ù…Ø·Ø±
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = ctx.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            // ÙÙ„ØªØ± Ù„Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØª ÙŠØ´Ø¨Ù‡ Ø§Ù„Ù…Ø·Ø±
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1000;
            
            rainGain = ctx.createGain();
            rainGain.gain.value = 0.5;
            
            whiteNoise.connect(filter);
            filter.connect(rainGain);
            rainGain.connect(ctx.destination);
            
            whiteNoise.start(0);
            return whiteNoise;
        }

        function createThunderSound() {
            const ctx = initAudioContext();
            
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = (Math.random() * 2 - 1) * 0.3;
            }
            
            const thunder = ctx.createBufferSource();
            thunder.buffer = noiseBuffer;
            thunder.loop = true;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 400;
            filter.Q.value = 0.5;
            
            thunderGain = ctx.createGain();
            thunderGain.gain.value = 0.5;
            
            thunder.connect(filter);
            filter.connect(thunderGain);
            thunderGain.connect(ctx.destination);
            
            thunder.start(0);
            return thunder;
        }

        function createWindSound() {
            const ctx = initAudioContext();
            
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = (Math.random() * 2 - 1) * 0.4;
            }
            
            const wind = ctx.createBufferSource();
            wind.buffer = noiseBuffer;
            wind.loop = true;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 800;
            filter.Q.value = 1;
            
            windGain = ctx.createGain();
            windGain.gain.value = 0.5;
            
            wind.connect(filter);
            filter.connect(windGain);
            windGain.connect(ctx.destination);
            
            wind.start(0);
            return wind;
        }

        // --- ØªØ´ØºÙŠÙ„ Ø£ØµÙˆØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ---
        function toggleSound(type) {
            const btn = document.getElementById('btn-' + type);
            
            if (!activeNatureSounds[type]) {
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
                if (type === 'rain') {
                    rainNoiseNode = createRainSound();
                } else if (type === 'thunder') {
                    thunderNoiseNode = createThunderSound();
                } else if (type === 'wind') {
                    windNoiseNode = createWindSound();
                }
                
                activeNatureSounds[type] = true;
                btn.innerHTML = "â¸";
                btn.classList.add('playing');
            } else {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
                if (type === 'rain' && rainNoiseNode) {
                    rainNoiseNode.stop();
                    rainNoiseNode = null;
                } else if (type === 'thunder' && thunderNoiseNode) {
                    thunderNoiseNode.stop();
                    thunderNoiseNode = null;
                } else if (type === 'wind' && windNoiseNode) {
                    windNoiseNode.stop();
                    windNoiseNode = null;
                }
                
                activeNatureSounds[type] = false;
                btn.innerHTML = "â–¶";
                btn.classList.remove('playing');
            }
        }

        function setVolume(type, val) {
            const volume = parseFloat(val);
            if (type === 'rain' && rainGain) {
                rainGain.gain.value = volume;
            } else if (type === 'thunder' && thunderGain) {
                thunderGain.gain.value = volume;
            } else if (type === 'wind' && windGain) {
                windGain.gain.value = volume;
            }
        }

        // --- Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ ---
        function playGentleSound() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // Ù†ØºÙ…Ø© Ù„Ø·ÙŠÙØ© ÙˆÙ‡Ø§Ø¯Ø¦Ø©
            oscillator.frequency.value = 523.25; // C5
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, ctx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.8);
        }

        function playBellSound() {
            const ctx = initAudioContext();
            
            // Ø¬Ø±Ø³ Ù…Ø¯Ø±Ø³Ø© - Ø¹Ø¯Ø© Ù†ØºÙ…Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©
            const times = [0, 0.15, 0.3, 0.45];
            const frequencies = [659.25, 783.99, 659.25, 783.99]; // E5, G5, E5, G5
            
            times.forEach((time, index) => {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = frequencies[index];
                oscillator.type = 'sine';
                
                const startTime = ctx.currentTime + time;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.4, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.3);
            });
        }

        function playSound(type) {
            try {
                if (type === 'snd_gentle') {
                    playGentleSound();
                } else if (type === 'snd_bell') {
                    playBellSound();
                }
            } catch (e) {
                console.log("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
            }
        }

        // --- Ø§Ù„Ø³Ø§Ø¹Ø© ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB', {hour12: false});
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date').innerText = now.toLocaleDateString('ar-EG', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        function switchTab(tab) {
            ['pomo', 'timer', 'tasks'].forEach(t => {
                document.getElementById(t + '-view').classList.add('hidden');
                document.getElementById('btn-' + t).classList.remove('active');
            });
            document.getElementById(tab + '-view').classList.remove('hidden');
            document.getElementById('btn-' + tab).classList.add('active');
        }

        // --- Ø¥ØµÙ„Ø§Ø­ Checkbox ---
        function toggleCheckbox() {
            const checkbox = document.getElementById('p_auto');
            checkbox.checked = !checkbox.checked;
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ ---
        let pTimer, pTimeLeft, pIsFocus = true, pCurrentCycle = 1, pIsPaused = false;
        
        function startPomo() {
            const focusMin = parseInt(document.getElementById('p_focus').value);
            const breakMin = parseInt(document.getElementById('p_short').value);
            const cycles = parseInt(document.getElementById('p_cycles').value);
            
            if (focusMin <= 0 || breakMin <= 0 || cycles <= 0) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©");
                return;
            }
            
            document.getElementById('pomo-setup').classList.add('hidden');
            document.getElementById('pomo-running').classList.remove('hidden');
            pCurrentCycle = 1;
            pIsFocus = true;
            runPomoSession();
        }

        function runPomoSession() {
            const focusMin = parseInt(document.getElementById('p_focus').value);
            const breakMin = parseInt(document.getElementById('p_short').value);
            
            pTimeLeft = (pIsFocus ? focusMin : breakMin) * 60;
            
            document.getElementById('p_status_text').innerText = pIsFocus ? "ğŸ¯ ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²" : "â˜• ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø©";
            document.getElementById('cycle_display').innerText = `${pCurrentCycle}/${document.getElementById('p_cycles').value}`;
            
            // ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            if (pIsFocus) {
                playSound('snd_gentle'); // ØµÙˆØª Ù„Ø·ÙŠÙ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„
            } else {
                playSound('snd_bell'); // Ø¬Ø±Ø³ Ù…Ø¯Ø±Ø³Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø§Ø­Ø©
            }

            clearInterval(pTimer);
            pIsPaused = false;
            document.getElementById('p_pause_btn').innerText = "â¸ Ø¥ÙŠÙ‚Ø§Ù";
            pTimer = setInterval(pTick, 1000);
            updatePomoDisplay();
            
            // ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            updateFocusTimerVisibility();
        }

        function pTick() {
            if (!pIsPaused) {
                pTimeLeft--;
                updatePomoDisplay();
                if (pTimeLeft <= 0) {
                    clearInterval(pTimer);
                    handlePomoEnd();
                }
            }
        }

        function handlePomoEnd() {
            if (pIsFocus) {
                // ğŸ”Š Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„ -> ØªØ´ØºÙŠÙ„ Ø¬Ø±Ø³ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                playSound('snd_bell');
                pIsFocus = false;
                if (document.getElementById('p_auto').checked) {
                    setTimeout(() => runPomoSession(), 2000);
                }
            } else {
                // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø§Ø­Ø©
                const totalCycles = parseInt(document.getElementById('p_cycles').value);
                if (pCurrentCycle < totalCycles) {
                    // ğŸ”Š ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù„Ø·ÙŠÙ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    playSound('snd_gentle');
                    pCurrentCycle++;
                    pIsFocus = true;
                    if (document.getElementById('p_auto').checked) {
                        setTimeout(() => runPomoSession(), 2000);
                    }
                } else {
                    // ğŸ”Š Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                    playSound('snd_bell');
                    setTimeout(() => {
                        alert("ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! Ø£Ø­Ø³Ù†Øª!");
                        resetPomo();
                    }, 500);
                }
            }
        }

        function updatePomoDisplay() {
            let m = Math.floor(pTimeLeft / 60);
            let s = pTimeLeft % 60;
            const timeStr = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            
            document.getElementById('p_timer_display').innerText = timeStr;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            document.getElementById('focus-timer-text').innerText = timeStr;
            document.getElementById('focus-timer-label').innerText = pIsFocus ? "ğŸ¯ ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²" : "â˜• ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø©";
            document.getElementById('focus-timer-cycle').innerText = `Ø¯ÙˆØ±Ø©: ${pCurrentCycle}/${document.getElementById('p_cycles').value}`;
        }

        function togglePausePomo() {
            pIsPaused = !pIsPaused;
            const btnText = pIsPaused ? "â–¶ Ø§Ø³ØªØ¦Ù†Ø§Ù" : "â¸ Ø¥ÙŠÙ‚Ø§Ù";
            document.getElementById('p_pause_btn').innerText = btnText;
            document.getElementById('focus-pause-btn').innerText = btnText;
        }
        
        function stopFocusTimer() {
            if (pTimer) {
                resetPomo();
            } else if (tRunning) {
                resetTimerDisplay();
            }
        }
        
        function resetPomo() {
            clearInterval(pTimer);
            pIsPaused = false;
            document.getElementById('pomo-setup').classList.remove('hidden');
            document.getElementById('pomo-running').classList.add('hidden');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±Ø¶ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            updateFocusTimerVisibility();
        }

        // --- ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø± ---
        let athkarInterval;
        const athkar = [
            "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡",
            "Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ…",
            "Ù„Ø§ Ø­ÙˆÙ„ ÙˆÙ„Ø§ Ù‚ÙˆØ© Ø¥Ù„Ø§ Ø¨Ø§Ù„Ù„Ù‡",
            "Ø§Ù„Ù„Ù‡Ù… ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø­Ù…Ø¯",
            "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ†",
            "Ù„Ø§ Ø¥Ù„Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ù„Ù‡",
            "Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±",
            "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ… ÙˆØ¨Ø­Ù…Ø¯Ù‡",
            "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø¹ÙˆØ° Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù‡Ù… ÙˆØ§Ù„Ø­Ø²Ù†"
        ];

        function toggleFocusMode() {
            document.body.classList.toggle('focus-active');
            
            if(document.body.classList.contains('focus-active')) {
                showAthkar();
                athkarInterval = setInterval(showAthkar, 8000);
            } else {
                clearInterval(athkarInterval);
            }
        }

        function showAthkar() {
            const el = document.getElementById('athkar-box');
            el.style.opacity = '0';
            
            setTimeout(() => {
                el.innerText = athkar[Math.floor(Math.random() * athkar.length)];
                el.style.opacity = '1';
            }, 1000);
        }

        // --- Ø§Ù„Ù…Ù‡Ø§Ù… ---
        function addTask() {
            const input = document.getElementById('task-input');
            const val = input.value.trim();
            
            if(val) {
                const li = document.createElement('li');
                li.className = 'task-item';
                
                const span = document.createElement('span');
                span.className = 'task-text';
                span.textContent = val;
                span.onclick = function() {
                    this.classList.toggle('completed');
                };
                
                const btn = document.createElement('button');
                btn.className = 'task-delete-btn';
                btn.innerHTML = 'âœ•';
                btn.onclick = function() {
                    li.remove();
                };
                
                li.appendChild(span);
                li.appendChild(btn);
                document.getElementById('task-list').appendChild(li);
                input.value = '';
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.addEventListener('DOMContentLoaded', function() {
            const taskInput = document.getElementById('task-input');
            if (taskInput) {
                taskInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addTask();
                    }
                });
            }
        });

        // --- Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠ ---
        let tTimer, tRunning = false, tTotalTime = 0;
        
        function handleTimerBtn() {
            if(!tRunning) {
                const min = parseInt(document.getElementById('t_min').value) || 0;
                const sec = parseInt(document.getElementById('t_sec').value) || 0;
                tTotalTime = min * 60 + sec;
                
                if(tTotalTime <= 0) {
                    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª ØµØ­ÙŠØ­");
                    return;
                }
                
                document.getElementById('timer-setup').classList.add('hidden');
                document.getElementById('timer-running-display').classList.remove('hidden');
                document.getElementById('t_action_btn').innerText = "â¹ Ø¥Ù„ØºØ§Ø¡";
                document.getElementById('t_action_btn').style.background = "var(--danger-color)";
                tRunning = true;
                
                // ØªØ­Ø¯ÙŠØ« Ø±Ø¤ÙŠØ© ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
                updateFocusTimerVisibility();
                
                tTimer = setInterval(() => {
                    tTotalTime--;
                    updateTimerDisplay();
                    
                    if(tTotalTime <= 0) {
                        clearInterval(tTimer);
                        playSound('snd_bell');
                        setTimeout(() => {
                            alert('â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!');
                            resetTimerDisplay();
                        }, 500);
                    }
                }, 1000);
                
                updateTimerDisplay();
            } else {
                clearInterval(tTimer);
                resetTimerDisplay();
            }
        }
        
        function updateTimerDisplay() {
            let m = Math.floor(tTotalTime / 60);
            let s = tTotalTime % 60;
            const timeStr = `${m}:${s<10?'0'+s:s}`;
            
            document.getElementById('t_display').innerText = timeStr;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            document.getElementById('focus-timer-text').innerText = timeStr;
            document.getElementById('focus-timer-label').innerText = "â³ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ";
            document.getElementById('focus-timer-cycle').innerText = "";
        }
        
        function updateFocusTimerVisibility() {
            const focusDisplay = document.getElementById('focus-timer-display');
            const focusControls = focusDisplay.querySelector('.focus-controls');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§ÙŠÙ…Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø£Ùˆ Ø§Ù„Ù…Ø¤Ù‚Øª Ø´ØºØ§Ù„
            if (pTimer || tRunning) {
                focusDisplay.classList.add('active');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                if (pTimer) {
                    focusControls.style.display = 'flex';
                    document.getElementById('focus-pause-btn').style.display = 'block';
                } else if (tRunning) {
                    focusControls.style.display = 'flex';
                    document.getElementById('focus-pause-btn').style.display = 'none';
                }
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§ÙŠÙ…Ø±
                focusDisplay.classList.remove('active');
            }
        }
        
        function resetTimerDisplay() {
            tRunning = false;
            clearInterval(tTimer);
            document.getElementById('timer-setup').classList.remove('hidden');
            document.getElementById('timer-running-display').classList.add('hidden');
            document.getElementById('t_action_btn').innerText = "â–¶ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª";
            document.getElementById('t_action_btn').style.background = "var(--accent-color)";
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±Ø¶ ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            updateFocusTimerVisibility();
        }
    </script>
</body>
</html>
